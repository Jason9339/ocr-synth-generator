# å…¨æ–°å·¥ä½œæµç¨‹ï¼šå…¨ç£ç¢Ÿé‹è¡Œ + LMDB æ ¼å¼

## ğŸ¯ æ–°æ¶æ§‹æ¦‚è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éšæ®µ 1: å…¨ç£ç¢Ÿç”Ÿæˆï¼ˆæœ¬æ©Ÿ SSDï¼‰                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ lines.txt â†’ [synth.py] â†’ JPG + manifest                    â”‚
â”‚                  â†“                                          â”‚
â”‚           /ocr_out_h  (æœ¬æ©Ÿæš«å­˜)                        â”‚
â”‚           /ocr_out_v  (æœ¬æ©Ÿæš«å­˜)                        â”‚
â”‚                  â†“                                          â”‚
â”‚           report_YYYYMMDD_HHMMSS.json (çµ±è¨ˆå ±å‘Š)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éšæ®µ 2: è½‰æ› LMDBï¼ˆæœ¬æ©Ÿï¼‰                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [convert_to_lmdb.py]                                        â”‚
â”‚     /ocr_out_h â†’ out_h.lmdb (å–®ä¸€æª”æ¡ˆ)                  â”‚
â”‚     /ocr_out_v â†’ out_v.lmdb (å–®ä¸€æª”æ¡ˆ)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éšæ®µ 3: å‚³è¼¸åˆ° NFSï¼ˆåªå‚³å…©å€‹æª”æ¡ˆï¼‰                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ rsync -a out_h.lmdb out_v.lmdb /mnt/whliao/lmdb/           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… å„ªå‹¢å°æ¯”

| é …ç›® | èˆŠç‰ˆï¼ˆNFS åŒæ­¥ï¼‰ | æ–°ç‰ˆï¼ˆLMDBï¼‰ |
|------|-----------------|--------------|
| **NFS I/O** | é«˜ï¼ˆç™¾è¬æ¬¡å°æª”å¯«å…¥ï¼‰ | **æ¥µä½ï¼ˆåªå‚³ 2 å€‹å¤§æª”ï¼‰** âœ… |
| **æœ¬æ©Ÿç©ºé–“** | 16GB/batchï¼ˆç«‹å³æ¸…ï¼‰ | å…¨éƒ¨æš«å­˜ï¼ˆ~80GBï¼‰â†’ å®Œæˆå¾Œæ¸… |
| **å‚³è¼¸æ•ˆç‡** | æ…¢ï¼ˆå¤§é‡å°æª”ï¼‰ | **å¿«ï¼ˆå–®ä¸€å¤§æª”ï¼‰** âœ… |
| **å¯é æ€§** | ä¸­ï¼ˆä¸­é€”ä¸­æ–·æ˜“çˆ›ï¼‰ | **é«˜ï¼ˆä¸€æ¬¡å®Œæˆå†å°åŒ…ï¼‰** âœ… |
| **è¨“ç·´è®€å–** | æ…¢ï¼ˆéœ€ open ç™¾è¬æ¬¡ï¼‰ | **å¿«ï¼ˆLMDB éš¨æ©Ÿå­˜å–ï¼‰** âœ… |
| **å‚™ä»½ç®¡ç†** | é›£ï¼ˆå·¨é‡å°æª”ï¼‰ | **æ˜“ï¼ˆåªæœ‰ 2 å€‹æª”æ¡ˆï¼‰** âœ… |

---

## ğŸš€ å®Œæ•´æ“ä½œæµç¨‹

### Step 1: å…¨ç£ç¢Ÿç”Ÿæˆ

```bash
# åŸ·è¡Œæœ¬æ©Ÿé‹è¡Œç‰ˆæœ¬ï¼ˆä¸åŒæ­¥ NFSï¼‰
./run_batch_local.sh

# æˆ–è‡ªè¨‚åƒæ•¸
./run_batch_local.sh \
  --out_dir_h /ocr_out_h \
  --out_dir_v /ocr_out_v \
  --batch_size 10000 \
  --num_workers 6
```

**åŸ·è¡Œå®Œæˆå¾Œæœƒè‡ªå‹•ç”¢ç”Ÿ**ï¼š
- `/ocr_out_h/` - æ°´å¹³åœ–ç‰‡ + manifest
- `/ocr_out_v/` - å‚ç›´åœ–ç‰‡ + manifest
- `report_YYYYMMDD_HHMMSS.json` - çµ±è¨ˆå ±å‘Š

**å ±å‘Šç¯„ä¾‹**ï¼š
```json
{
  "timestamp": "2025-10-09T12:34:56+08:00",
  "duration_seconds": 3600,
  "duration_human": "1h 0m 0s",
  "output": {
    "horizontal": {
      "image_count": 200000,
      "size": "16G",
      "errors": 0
    },
    "vertical": {
      "image_count": 200000,
      "size": "16G",
      "errors": 0
    },
    "total_images": 400000
  }
}
```

---

### Step 2: è½‰æ›ç‚º LMDB

```bash
# å®‰è£ lmdbï¼ˆå¦‚æœé‚„æ²’è£ï¼‰
pip install lmdb tqdm

# è½‰æ›æ°´å¹³åœ–ç‰‡
python3 convert_to_lmdb.py \
  --src /ocr_out_h \
  --dst out_h.lmdb \
  --verify

# è½‰æ›å‚ç›´åœ–ç‰‡
python3 convert_to_lmdb.py \
  --src /ocr_out_v \
  --dst out_v.lmdb \
  --verify
```

**è¼¸å‡ºç¯„ä¾‹**ï¼š
```
Reading manifest: /ocr_out_h/manifest_h_all.jsonl
Found 200000 entries in manifest
Creating LMDB: out_h.lmdb
  Estimated size: 19531.2 MB
Writing to LMDB: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 200000/200000 [02:15<00:00, 1479.23it/s]

âœ“ LMDB created successfully!
  Entries: 200000
  Size: 16384.5 MB
  Location: /home/jason/ocr-synth-generator/out_h.lmdb
```

---

### Step 3: å‚³è¼¸åˆ° NFSï¼ˆåªå‚³ 2 å€‹å¤§æª”ï¼‰

```bash
# å‰µå»º NFS ç›®æ¨™ç›®éŒ„
mkdir -p /mnt/whliao/lmdb

# å‚³è¼¸ LMDB æª”æ¡ˆï¼ˆåªæœ‰ 2 å€‹æª”æ¡ˆï¼ï¼‰
rsync -avh --progress out_h.lmdb out_v.lmdb /mnt/whliao/lmdb/

# æˆ–ä½¿ç”¨ scpï¼ˆå¦‚æœæ˜¯é ç«¯ï¼‰
scp out_h.lmdb out_v.lmdb user@nas:/mnt/whliao/lmdb/
```

**å‚³è¼¸é€Ÿåº¦å°æ¯”**ï¼š
- èˆŠç‰ˆï¼ˆç™¾è¬å€‹ .jpgï¼‰ï¼šæ•¸å°æ™‚ï¼Œå®¹æ˜“ä¸­æ–·
- æ–°ç‰ˆï¼ˆ2 å€‹ .lmdbï¼‰ï¼šæ•¸åˆ†é˜ï¼Œç©©å®šå¿«é€Ÿ âœ…

---

### Step 4: ï¼ˆå¯é¸ï¼‰æ¸…ç†æœ¬æ©Ÿæš«å­˜

```bash
# ç¢ºèª LMDB å·²æˆåŠŸå‚³è¼¸å¾Œ
ls -lh /mnt/whliao/lmdb/

# æ¸…ç†æœ¬æ©Ÿåœ–ç‰‡ï¼ˆé‡‹æ”¾ç©ºé–“ï¼‰
rm -rf /ocr_out_h /ocr_out_v
```

---

## ğŸ“Š ç©ºé–“éœ€æ±‚ä¼°ç®—

å‡è¨­ç”Ÿæˆ **100 è¬å¼µåœ–ç‰‡**ï¼ˆ50 è¬æ°´å¹³ + 50 è¬å‚ç›´ï¼‰ï¼š

| éšæ®µ | æœ¬æ©Ÿç©ºé–“ | NFS ç©ºé–“ |
|------|---------|----------|
| ç”Ÿæˆä¸­ | ~80GBï¼ˆå…¨éƒ¨åœ–ç‰‡ï¼‰ | 0 |
| è½‰ LMDB | ~160GBï¼ˆåœ–ç‰‡ + LMDBï¼‰ | 0 |
| å‚³è¼¸å¾Œ | 0ï¼ˆå¯æ¸…ç†ï¼‰ | ~80GBï¼ˆ2 å€‹ LMDBï¼‰ |

**é—œéµ**ï¼šæœ¬æ©Ÿéœ€è‡³å°‘ **200GB å¯ç”¨ç©ºé–“**ï¼ˆå«å®‰å…¨é‚Šéš›ï¼‰

---

## ğŸ” é©—è­‰ LMDB

### å¿«é€Ÿé©—è­‰
```bash
python3 convert_to_lmdb.py --src /ocr_out_h --dst test.lmdb --verify
```

### æ‰‹å‹•é©—è­‰ï¼ˆPythonï¼‰
```python
import lmdb
import json

env = lmdb.open('out_h.lmdb', readonly=True)

with env.begin() as txn:
    # è®€å– metadata
    metadata = json.loads(txn.get(b'__metadata__'))
    print(f"Total samples: {metadata['num_samples']}")

    # è®€å–ç¬¬ä¸€ç­†è³‡æ–™
    img_bytes = txn.get(b'image-00000000')
    label_bytes = txn.get(b'label-00000000')

    print(f"Image size: {len(img_bytes)} bytes")
    print(f"Label: {label_bytes.decode('utf-8')}")

env.close()
```

---

## ğŸ“ è¨“ç·´æ™‚å¦‚ä½•ä½¿ç”¨ LMDB

### PyTorch Dataset ç¯„ä¾‹

```python
import lmdb
import io
from PIL import Image
from torch.utils.data import Dataset

class LMDBDataset(Dataset):
    def __init__(self, lmdb_path, transform=None):
        self.env = lmdb.open(str(lmdb_path), readonly=True, lock=False)
        with self.env.begin() as txn:
            metadata = json.loads(txn.get(b'__metadata__'))
            self.length = metadata['num_samples']
        self.transform = transform

    def __len__(self):
        return self.length

    def __getitem__(self, idx):
        with self.env.begin() as txn:
            img_key = f'image-{idx:08d}'.encode()
            label_key = f'label-{idx:08d}'.encode()

            img_bytes = txn.get(img_key)
            label_bytes = txn.get(label_key)

            # Decode image
            img = Image.open(io.BytesIO(img_bytes)).convert('RGB')
            label = label_bytes.decode('utf-8')

            if self.transform:
                img = self.transform(img)

            return img, label

# ä½¿ç”¨
dataset = LMDBDataset('out_h.lmdb', transform=transforms.ToTensor())
loader = DataLoader(dataset, batch_size=32, shuffle=True, num_workers=4)
```

---

## âš™ï¸ åƒæ•¸èª¿æ•´å»ºè­°

### æœ¬æ©Ÿç©ºé–“ä¸è¶³æ™‚

```bash
# æ¸›å° batch_sizeï¼ˆé™ä½å³°å€¼ä½”ç”¨ï¼‰
./run_batch_local.sh --batch_size 5000

# æˆ–åˆ†æ®µåŸ·è¡Œ
./run_batch_local.sh --batch_size 10000  # ç”Ÿæˆä¸€åŠ
python3 convert_to_lmdb.py ...           # ç«‹å³è½‰ LMDB
rm -rf /tmp/ocr_out_*                   # æ¸…ç†
# å†åŸ·è¡Œå¦ä¸€åŠ...
```

### åŠ é€Ÿç”Ÿæˆ

```bash
# å¢åŠ  worker æ•¸é‡
./run_batch_local.sh --num_workers 12

# æ¸›å°‘æ¯è¡Œåœ–ç‰‡æ•¸ï¼ˆæ¸¬è©¦ç”¨ï¼‰
./run_batch_local.sh --n_per_line 10
```

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### Q: LMDB è½‰æ›æ™‚è¨˜æ†¶é«”ä¸è¶³

```bash
# æª¢æŸ¥è¨˜æ†¶é«”ä½¿ç”¨
free -h

# æ¸›å°‘è™•ç†æ‰¹æ¬¡ï¼ˆç›®å‰æ˜¯ä¸€æ¬¡å…¨éƒ¨è¼‰å…¥ï¼‰
# å¦‚æœé‡åˆ°å•é¡Œï¼Œå¯ä»¥æ”¹å¯« convert_to_lmdb.py ä½¿ç”¨åˆ†æ‰¹å¯«å…¥
```

### Q: æœ¬æ©Ÿç©ºé–“ä¸å¤ 

```bash
# æª¢æŸ¥å¯ç”¨ç©ºé–“
df -h /tmp

# é¸é … 1: ä½¿ç”¨å…¶ä»–æœ¬æ©Ÿè·¯å¾‘
./run_batch_local.sh --out_dir_h /root/ocr_out_h

# é¸é … 2: åˆ†æ®µç”Ÿæˆï¼ˆè¦‹ä¸Šæ–¹åƒæ•¸èª¿æ•´ï¼‰
```

### Q: LMDB æª”æ¡ˆéå¤§

```bash
# æª¢æŸ¥å–®å€‹ LMDB å¤§å°
du -h out_h.lmdb

# å¦‚æœè¶…é 100GBï¼Œå»ºè­°åˆ†æˆå¤šå€‹ LMDB
# ä¿®æ”¹è…³æœ¬æ”¯æ´å¤šå€‹è¼¸å‡ºæª”æ¡ˆ
```

---

## ğŸ“ å®Œæ•´å·¥ä½œæµç¨‹ç¯„ä¾‹

```bash
# ========================================
# å®Œæ•´æµç¨‹ï¼ˆ100 è¬å¼µåœ–ç¯„ä¾‹ï¼‰
# ========================================

# 1. åŸ·è¡Œç”Ÿæˆï¼ˆç´„ 1-2 å°æ™‚ï¼‰
./run_batch_local.sh

# 2. æª¢æŸ¥å ±å‘Š
cat report_*.json

# 3. è½‰æ› LMDBï¼ˆç´„ 5-10 åˆ†é˜ï¼‰
python3 convert_to_lmdb.py --src /ocr_out_h --dst out_h.lmdb --verify
python3 convert_to_lmdb.py --src /ocr_out_v --dst out_v.lmdb --verify

# 4. å‚³è¼¸åˆ° NFSï¼ˆç´„ 5-15 åˆ†é˜ï¼‰
rsync -avh --progress out_h.lmdb out_v.lmdb /mnt/whliao/lmdb/

# 5. é©—è­‰å‚³è¼¸æˆåŠŸ
ls -lh /mnt/whliao/lmdb/

# 6. æ¸…ç†æœ¬æ©Ÿï¼ˆé‡‹æ”¾ ~160GBï¼‰
rm -rf /ocr_out_h /ocr_out_v
```

---

## ğŸ‰ ç¸½çµ

### ç‚ºä»€éº¼é€™å€‹æ–¹æ¡ˆæ›´å¥½ï¼Ÿ

1. **NFS å‹å–„**ï¼šåªå‚³ 2 å€‹å¤§æª”ï¼Œé¿é–‹å°æª” I/O åœ°ç„
2. **æœ¬æ©Ÿé«˜æ•ˆ**ï¼šç”Ÿæˆæ™‚ 100% SSD é€Ÿåº¦
3. **è¨“ç·´å¿«é€Ÿ**ï¼šLMDB éš¨æ©Ÿå­˜å–æ¯” open() ç™¾è¬æ¬¡å¿«å¾—å¤š
4. **å®¹æ˜“ç®¡ç†**ï¼šå‚™ä»½/å‚³è¼¸/åˆªé™¤åªéœ€è™•ç† 2 å€‹æª”æ¡ˆ
5. **å¯é ç©©å®š**ï¼šä¸€æ¬¡å®Œæˆå†å°åŒ…ï¼Œä¸­é€”ä¸­æ–·æå¤±å°

### èˆ‡èˆŠç‰ˆå°æ¯”

| æ“ä½œ | èˆŠç‰ˆ | æ–°ç‰ˆ |
|------|------|------|
| ç”Ÿæˆ 100 è¬å¼µåœ– | åˆ†æ‰¹åŒæ­¥ NFSï¼Œæ…¢ | å…¨æœ¬æ©Ÿï¼Œå¿« âœ… |
| å‚³è¼¸åˆ° NFS | æ•¸å°æ™‚ï¼Œæ˜“ä¸­æ–· | æ•¸åˆ†é˜ï¼Œç©©å®š âœ… |
| è¨“ç·´è¼‰å…¥ | æ…¢ï¼ˆéœ€ open ç™¾è¬æ¬¡ï¼‰ | å¿«ï¼ˆLMDBï¼‰ âœ… |
| å‚™ä»½ | é›£ï¼ˆå·¨é‡å°æª”ï¼‰ | æ˜“ï¼ˆ2 å€‹å¤§æª”ï¼‰ âœ… |

**å»ºè­°**ï¼šé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ï¼ˆå¦‚éœ€è¦ç›´æ¥å­˜å– JPGï¼‰ï¼Œå¦å‰‡ä¸€å¾‹ä½¿ç”¨ LMDB æ–¹æ¡ˆï¼
